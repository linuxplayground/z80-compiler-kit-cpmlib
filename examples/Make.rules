include $(TOP)/examples/Make.default
-include $(TOP)/examples/Make.local

INCLUDES=-I. -I$(TOP)/include/arch/$(ARCH)
include $(TOP)/Make.rules

BUILD_DIR=$(TOP)/build/arch/$(ARCH)/examples/$(APPNAME)

CRT0=$(TOP)/build/arch/$(ARCH)/crt0.o

.PHONY: all clean world copy
.INTERMEDIATE: $(BUILD_DIR)/$(APPNAME).bin

all:: $(BUILD_DIR)/$(APPNAME).com

$(BUILD_DIR)/$(APPNAME).o: $(APPNAME).c
	@mkdir -pv $(BUILD_DIR)
	$(CC) $(CFLAGS) $(CPPFLAGS) -c -o $@ $^

$(BUILD_DIR)/$(APPNAME).bin: $(BUILD_DIR)/$(APPNAME).o
	$(LD) $(LDFLAGS) -o $@ $(CRT0) $^ $(LDLIBS)

$(BUILD_DIR)/$(APPNAME).com: $(BUILD_DIR)/$(APPNAME).bin
	dd if=$^ of=$@ skip=1 bs=256

clean:
	rm -rf $(BUILD_DIR)

world:: clean all

# copy examples to emulator assuming you have a /dev/loop0 device all setup.
copy: $(BUILD_DIR)/$(APPNAME).com
	cpmrm -f z80-retro-8k-8m /dev/loop0p1 0:$(APPNAME).com
	cpmcp -f z80-retro-8k-8m /dev/loop0p1 $(BUILD_DIR)/$(APPNAME).com 0:

# vim: set ft=make noet:
